name: Scan CRAN packages

on:
  schedule:
    - cron: '0 */4 * * *'
  workflow_dispatch:
    inputs:
      batch_size:
        description: 'Number of packages to scan'
        default: '500'
        required: false

jobs:
  scan:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/osgeo/gdal:ubuntu-full-latest

    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - uses: actions/checkout@v4

      - name: Install R and dependencies
        run: |
          apt-get update
          apt-get install -y --no-install-recommends \
            r-base \
            r-base-dev \
            libcurl4-openssl-dev \
            libssl-dev \
            libxml2-dev \
            libfontconfig1-dev \
            libharfbuzz-dev \
            libfribidi-dev \
            libfreetype6-dev \
            libpng-dev \
            libtiff5-dev \
            libjpeg-dev \
            git

      - name: Install R packages
        run: |
           Rscript -e '
            install.packages("remotes", repos = "https://cloud.r-project.org")
            remotes::install_local(".", dependencies = TRUE, upgrade = "never")
          '

      - name: Verify GDAL
        run: |
          gdalinfo --version
          Rscript -e 'gdalraster::gdal_version()'
          Rscript -e 'length(gdalraster::gdal_drivers()$name)'

      - name: Download previous catalog
        run: |
          Rscript -e '
            url <- tryCatch({
              rel <- gh::gh("GET /repos/{owner}/{repo}/releases/tags/{tag}",
                            owner = "hypertidy", repo = "vsils", tag = "catalog")
              idx <- which(sapply(rel$assets, \(a) a$name) == "scranned.parquet")
              if (length(idx)) rel$assets[[idx]]$browser_download_url else stop("no asset")
            }, error = function(e) NULL)

            if (!is.null(url)) {
              download.file(url, "scranned.parquet", mode = "wb")
              message("Downloaded existing catalog")
            } else {
              message("No existing catalog, starting fresh")
              arrow::write_parquet(
                tibble::tibble(
                  package = character(),
                  version = character(),
                  driver = character(),
                  dsn = character(),
                  scanned_at = as.POSIXct(character())
                ),
                "scranned.parquet"
              )
            }
          '

      - name: Scan batch
        run: |
          Rscript inst/scripts/scan-batch.R ${{ github.event.inputs.batch_size || '500' }}

      - name: Upload catalog to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: catalog
          name: CRAN Spatial Data Catalog
          files: scranned.parquet
          body: "Catalog of GDAL-readable files in CRAN packages. Built with GDAL ubuntu-full-latest. Download: arrow::read_parquet('https://github.com/hypertidy/vsils/releases/download/catalog/scranned.parquet')"
